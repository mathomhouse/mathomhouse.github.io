<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bobgrif's Titan Gear Runes</title>
  <link rel="stylesheet" href="styles/index.css">
  <script src="/test/header2.js" defer></script>
  <style>
  #comboResults {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
  }

  #comboResults .gear-box:last-child {
    flex-basis: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 16px;
    box-sizing: border-box;
  }

  .ht-slot {
    text-align: center;
    font-weight: bold;
    margin-bottom: 10px;
    font-size: 1.1em;
  }

  .ht-icons {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
  }

  .ht-icons img {
    width: 64px;
    height: 64px;
    object-fit: contain;
  }

  .ht-name {
    font-size: 1em;
    text-align: center;
    line-height: 1.2;
    font-weight: 500;
  }

  /* Keep HT section full width and on bottom */
  #comboResults .gear-box:last-child {
    flex-basis: 100%;
  }

  /* Make hero boxes consistent width */
  #comboResults .gear-box {
    flex: 1 1 300px;
    max-width: 300px;
  }

  /* On small screens, stack vertically (default behavior) */
  @media (max-width: 768px) {
    #comboResults {
      flex-direction: column;
      align-items: center;
    }

    #comboResults .gear-box {
      max-width: 100%;
    }
  }

  .gear-box {
    width: 300px;
  }

  .gear-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-top: 12px;
  }

  .gear-slot {
    display: grid;
    grid-template-rows: auto 48px auto;
    align-items: center;
    justify-items: center;
    text-align: center;
    height: 160px;
  }

  .gear-slot p {
    margin: 4px 0;
    line-height: 1.2;
    max-width: 120px;
    word-wrap: break-word;
  }

  .gear-slot p:nth-child(1),
  .gear-slot p:nth-child(3) {
    min-height: 2.2em;
  }

  .gear-slot img {
    height: 64px;
    margin: 4px 0;
  }

  input[type="number"],
  select {
    max-width: 150px;
  }

  .tabs {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .tab-button {
    padding: 10px 20px;
    font-size: 16px;
    background: var(--accent-color, #333);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }

  .tab-button.active {
    background: var(--accent-hover, #555);
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }
  /* Center-align HT Section */
  #comboResults .gear-box:last-child {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background-color: rgba(0, 0, 0, 0.03); /* Optional: subtle background */
    padding: 20px;
    box-sizing: border-box;
  }

  /* Change HT gear grid layout to centered flex */
  #comboResults .gear-box:last-child .gear-grid {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 20px;
  }

  /* Stack chip + HT vertically */
  .ht-icons {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
  }

  /* Chip image adjustments */
  .ht-icons img {
    width: 48px;
    height: 48px;
    object-fit: contain;
  }

  /* Chip name styling */
  .chip-name {
    font-size: 0.9em;
    margin-top: 4px;
    text-align: center;
  }
  /* Aligns HT Icons side by side */
  .ht-icon-row {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
  }

  /* Ensures each image + name is stacked */
  .ht-icon-column {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  /* Ensure consistent image sizes */
  .ht-icon-column img {
    width: 100px;
    height: 100px;
    object-fit: contain;
  }

  /* Name styling */
  .chip-name, .ht-name {
    font-size: 0.9em;
    margin-top: 4px;
    text-align: center;
  }
  .skeleton-box {
    background: linear-gradient(90deg, #eee 25%, #ddd 50%, #eee 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite linear;
    border-radius: 12px;
    width: 300px;
    height: 200px;
    margin: 10px;
  }

  @keyframes skeleton-loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

</style>
</head>
<body>
<header id="header-placeholder"></header>

<div class="container">
  <h1>Bobgrif's Runes Guide</h1>
  <p>This guide was made in collaboration with Bobgrif, who provided all the data to help you figure out how you should set up the runes in your marches!
    <br><br>
    Use the tabs below to view various loadouts by hero or see the Bobgrif's recommended marches and the runes they make.
  </p>

  <div class="tabs">
    <button class="tab-button active" onclick="openTab('loadouts')">Rune Loadouts</button>
    <button class="tab-button" onclick="openTab('combos')">Suggested Marches</button>
  </div>

  <!-- Loadouts Tab -->
  <div id="loadouts" class="tab-content active">
    <label for="branch">Choose Branch:</label><br>
    <select id="branch" onchange="filterHeroesByRole()">
      <option value="" disabled selected>Select branch</option>
      <option value="Army">Army</option>
      <option value="Navy">Navy</option>
      <option value="Air Force">Air Force</option>
    </select><br>

    <label for="heroAttack">Attack Hero:</label><br>
    <select id="heroAttack"></select><br>
    <label for="heroHP">HP Hero:</label><br>
    <select id="heroHP"></select><br>
    <label for="heroIndestructible">Indestructible Hero:</label><br>
    <select id="heroIndestructible"></select>

    <div class="calculate-btn">
      <button onclick="showGear()">View Rune Loadouts</button>
    </div>

    <div id="results" class="gear-container">
      <div class="skeleton-box"></div>
      <div class="skeleton-box"></div>
      <div class="skeleton-box"></div>
    </div>

  </div>

  <!-- Hero Combos Tab -->
  <div id="combos" class="tab-content">
    <h2>Recommended Hero Combinations + Runes</h2>
    <p>Select your Exclusive Skill Level and March Type to view suggested hero and rune combinations.</p>

    <label for="skillLevel">Exclusive Skill Level:</label>
  <select id="skillLevel" onchange="updateMarchOptions()">
    <option value="" disabled selected>Select option</option>
    <option value="Level 5 Skill">Level 5</option>
    <option value="Level 7 Skill">Level 7</option>
  </select>

  <label for="marchType">March Type:</label>
  <select id="marchType">
    <option value="" disabled selected>Select option</option>
  </select>

  <div class="calculate-btn">
    <button onclick="renderHeroCombos()">View Suggested Marches</button>
  </div>

    <div id="comboResults" style="margin-top: 20px;">
      <div class="skeleton-box"></div>
      <div class="skeleton-box"></div>
    </div>
  </div>
</div>

<script>
let titanGearData = [];
let suggestedCombosData = {};
let heavyTrooperData = {};

const liveUrl = 'https://invalid-url-to-force-fallback.com';

const fallbackUrl = 'titan-gear-data.json';

fetch(liveUrl)
  .then(res => {
    if (!res.ok) throw new Error("Live data unavailable");
    return res.json();
  })
  .then(data => {
    console.log("Live data loaded");
    titanGearData = data.titanGearData;
    suggestedCombosData = data.suggestedCombos;
    heavyTrooperData = data.heavyTroopers || {};
    console.log("Heavy Troopers:", heavyTrooperData);
    filterHeroesByRole();
      document.getElementById('results').innerHTML = ''; // Clear Rune Loadouts skeleton
      document.getElementById('comboResults').innerHTML = ''; // Clear Suggested Marches skeleton
    updateMarchOptions();
  })
  .catch(err => {
  console.warn("Falling back to static data:", err.message);

  // Inject fallback banner at the top of the body
  document.body.insertAdjacentHTML('afterbegin', `
    <div id="fallback-banner" style="
      background-color: #ffdddd;
      color: #900;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      border-bottom: 2px solid #900;
      font-family: sans-serif;
    ">
      ⚠️ Live data could not be loaded. Displaying cached data.
    </div>
  `);

  // Proceed with fetching fallback data
  fetch(fallbackUrl)
    .then(res => res.json())
    .then(data => {
      console.log("Fallback data loaded");
      titanGearData = data.titanGearData;
      suggestedCombosData = data.suggestedCombos;
      heavyTrooperData = data.heavyTroopers || {};
      console.log("Heavy Troopers (fallback):", heavyTrooperData);
      filterHeroesByRole();

      // Clear Skeletons for both sections
      document.getElementById('results').innerHTML = '';
      document.getElementById('comboResults').innerHTML = '';
    });
});
;

function openTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  event.target.classList.add('active');
}

function filterHeroesByRole() {
  const branch = document.getElementById('branch').value;

  if (!branch) {
    populateDropdown('heroAttack', []);
    populateDropdown('heroHP', []);
    populateDropdown('heroIndestructible', []);
    return;
  }

  const attackHeroes = titanGearData
    .filter(h => (h.Branch === branch || h.Branch === "Universal") && h.Subcategory === "Attack")
    .map(h => h.Hero);

  const hpHeroes = titanGearData
    .filter(h => (h.Branch === branch || h.Branch === "Universal") && h.Subcategory === "HP")
    .map(h => h.Hero);

  const indestructibleHeroes = titanGearData
    .filter(h => (h.Branch === branch || h.Branch === "Universal") && h.Subcategory === "Indestructible")
    .map(h => h.Hero);

  populateDropdown('heroAttack', attackHeroes);
  populateDropdown('heroHP', hpHeroes);
  populateDropdown('heroIndestructible', indestructibleHeroes);
}

function populateDropdown(dropdownId, heroList) {
  const select = document.getElementById(dropdownId);
  select.innerHTML = "";
  heroList.forEach(hero => {
    const option = document.createElement("option");
    option.value = hero;
    option.textContent = hero;
    select.appendChild(option);
  });
}

function showGear() {
  const branch = document.getElementById('branch').value;
  const selections = [
    { role: "Attack", id: "heroAttack" },
    { role: "HP", id: "heroHP" },
    { role: "Indestructible", id: "heroIndestructible" }
  ];

  const resultsDiv = document.getElementById('results');
  resultsDiv.innerHTML = '';

  selections.forEach(({ role, id }) => {
    const heroName = document.getElementById(id).value.trim();
    const hero = titanGearData.find(item =>
      item.Hero.trim() === heroName &&
      item.Branch === branch
    );
    if (!hero || !hero.Loadouts) return;

    const heroBox = document.createElement('div');
    heroBox.className = 'gear-box';
    heroBox.dataset.hero = hero.Hero;
    heroBox.dataset.branch = branch;

    const loadoutKeys = Object.keys(hero.Loadouts);
    const defaultLoadout = loadoutKeys[0];
    const gear = hero.Loadouts[defaultLoadout];

    heroBox.innerHTML = `
      <h2>${hero.Hero}<br> <span style="font-size: 0.7em;">(${role})</span></h2>
      <label>Loadout:</label>
      <select class="hero-loadout" data-hero="${hero.Hero}" data-branch="${branch}" onchange="updateDynamicGear(this)">
        ${loadoutKeys.map(key => `<option value="${key}">${key}</option>`).join('')}
      </select>
      <div class="gear-details" id="gear-${hero.Hero}-${branch}">
        ${renderGearDetails(gear)}
      </div>
    `;
    resultsDiv.appendChild(heroBox);
  });
}

function updateDynamicGear(selectElement) {
  const heroName = selectElement.dataset.hero;
  const branch = selectElement.dataset.branch;
  const selectedLoadout = selectElement.value;

  const hero = titanGearData.find(item =>
    item.Hero.trim() === heroName &&
    item.Branch === branch
  );
  const gear = hero?.Loadouts?.[selectedLoadout];

  const gearDiv = document.getElementById(`gear-${heroName}-${branch}`);
  if (gearDiv && gear) {
    gearDiv.innerHTML = renderGearDetails(gear);
  }
}

function renderGearDetails(gear) {
  const displayNames = {
    Gun: 'Assault Pistol',
    Chest: 'Tactical Backarmor',
    Optical: 'Optical Add-on',
    Headset: 'Raytheon Headset',
    Arms: 'Portable GPS',
    Boots: 'Power Boots'
  };

  const slotOrder = [
    ['Gun', 'Headset'],
    ['Chest', 'Arms'],
    ['Optical', 'Boots']
  ];

  return `<div class="gear-grid">` + slotOrder.map(pair => {
    return pair.map(slot => {
      const rune = gear[slot];
      const iconPath = `images/runes/${rune}.png`;
      return `
        <div class="gear-slot">
          <p><strong>${displayNames[slot]}</strong></p>
          <img src="${iconPath}" alt="${rune}" title="${rune}" />
          <p>${rune}</p>
        </div>
      `;
    }).join('');
  }).join('') + `</div>`;
}

function updateMarchOptions() {
  const skillLevel = document.getElementById('skillLevel').value;
  const marchSelect = document.getElementById('marchType');
  marchSelect.innerHTML = '';

  const marchTypes = Object.keys(suggestedCombosData[skillLevel] || {});
  marchTypes.forEach(march => {
    const opt = document.createElement('option');
    opt.value = march;
    opt.textContent = march;
    marchSelect.appendChild(opt);
  });
}

function renderHeroCombos() {
  const skillLevel = document.getElementById('skillLevel').value;
  const marchType = document.getElementById('marchType').value;
  const resultsDiv = document.getElementById('comboResults');
  resultsDiv.innerHTML = '';

  const heroes = suggestedCombosData[skillLevel]?.[marchType] || [];
  const heavyTroopers = heavyTrooperData?.[marchType] || [];
  console.log(`Rendering combos for: ${marchType}`, heavyTroopers);

  // Hero gear boxes
  heroes.forEach(heroObj => {
    const box = document.createElement('div');
    box.className = 'gear-box';
    box.innerHTML = `
      <h3>${heroObj.Hero}</h3>
      ${renderGearDetails(heroObj.Gear)}
    `;
    resultsDiv.appendChild(box);
  });

  // HT box
  if (heavyTroopers.length) {
    const box = document.createElement('div');
    box.className = 'gear-box';
    box.innerHTML = `
      <h3>Heavy Trooper</h3>
      <div class="gear-grid">
        ${heavyTroopers.map(ht => {
          const htIconMap = {
            "Earthshaker E-100": "yellow",
            "Blazing Gale Rx": "red",
            "Tide Crusher BW-3": "blue",
            "Doom Sawblade D-4": "ball",
            "Luminary Knight LP-4": "white",
            "Blade Angel BA-6": "pink"
          };

          const chipIconMap = {
            "Xyston": "xyston",
            "Hoplon": "hoplon",
            "Shamshir": "shamshir",
            "Estoc Piercing Sword": "estoc",
            "Rondel Dagger": "rondel",
            "Scramsax Blade": "scramsax",
            "Kris Sword": "kris-sword",
            "Ring of Cosmos": "cosmos",
            "Sasanian's Chain": "sasanian"
          };

          const htKey = htIconMap[ht.trooper] || "unknown";
          const chipKey = chipIconMap[ht.chipType] || "unknown";

          return `
            <div class="ht-slot">Slot ${ht.slot}</div>
            <div class="gear-slot">
              <div class="ht-icon-row">
                <div class="ht-icon-column">
                  <img src="images/${chipKey}-icon.png" alt="${ht.chipType}" title="${ht.chipType}" />
                  <div class="chip-name">${ht.chipType}</div>
                </div>
                <div class="ht-icon-column">
                  <img src="images/${htKey}-ht-icon.png" alt="${ht.trooper}" title="${ht.trooper}" />
                  <div class="ht-name">${ht.trooper}</div>
                </div>
              </div>
            </div>
          `;

        }).join('')}
      </div>
    `;
    resultsDiv.appendChild(box);
  }
}
</script>

</body>
</html>
