<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Perk Tree Prototype</title>
<link rel="stylesheet" href="/styles/index.css" />
<style>
    body {
    background: #0a0f1c;
    color: white;
    margin: 0;
    font-family: sans-serif;
}

.tree-wrapper {
    width: 100%;
    height: 100vh;
    overflow-y: auto;
    position: relative;
}

#tree-lines {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
}

.tree-grid {
    position: relative;
    display: grid;
    grid-template-columns: repeat(5, 140px);
    grid-auto-rows: 160px;
    justify-content: center;
    padding-top: 50px;
    padding-bottom: 200px;
}

.talent-node {
    width: 110px;
    height: 120px;
    margin: auto;
    cursor: pointer;
}

.talent-node-inner {
    width: 100%;
    height: 100%;
    clip-path: polygon(
        25% 0%, 75% 0%,
        100% 50%,
        75% 100%, 25% 100%,
        0% 50%
    );
    background: #1d2333;
    border: 3px solid #476da5;
    box-shadow: 0 0 8px rgba(71,109,165,0.5);
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: center;
    padding-bottom: 10px;
}

.talent-node.locked .talent-node-inner {
    opacity: 0.35;
    border-color: #2c2c2c;
    box-shadow: none;
}

.talent-node.available .talent-node-inner {
    border-color: #5cb3ff;
    box-shadow: 0 0 12px rgba(92,179,255,0.6);
}

.talent-node.maxed .talent-node-inner {
    border-color: #1ad46b;
    box-shadow: 0 0 20px rgba(26,212,107,0.8);
}

.talent-node-icon {
    width: 60px;
    height: 60px;
    margin-bottom: 8px;
}

.talent-level-text {
    font-size: 16px;
    font-weight: bold;
    text-shadow: 0 0 5px black;
}

.points-display {
    position: fixed;
    top: 10px;
    left: 10px;
    background: #1d2333;
    padding: 8px 12px;
    border: 2px solid #476da5;
    border-radius: 6px;
    box-shadow: 0 0 10px rgba(71,109,165,0.5);
    font-size: 18px;
}

</style>
<script src="/header.js" defer></script>
</head>
<body>
    <header id="header-placeholder"></header>

<div class="tree-wrapper">
    <svg id="tree-lines"></svg>
    <div id="tree" class="tree-grid"></div>
</div>

<div class="points-display">
    Talent Points: <span id="points">50</span>
</div>

<script>
    // ---------------------------------------------------------
// JSON: sample perk tree data (you can expand later)
// ---------------------------------------------------------
const talentTree = {
    pointsAvailable: 50,
    nodes: [
        {
            id: "army_hp",
            name: "Army HP",
            icon: "https://via.placeholder.com/60x60/88f/000?text=HP",
            maxLevel: 5,
            costPerLevel: [6,6,6,6,6],
            row: 1,
            col: 3,
            prereq: null
        },
        {
            id: "army_atk",
            name: "Army ATK",
            icon: "https://via.placeholder.com/60x60/f88/000?text=ATK",
            maxLevel: 5,
            costPerLevel: [6,6,6,6,6],
            row: 2,
            col: 2,
            prereq: {
                type: "all",
                nodes: ["army_hp"],
                minCompleted: 1
            }
        },
        {
            id: "navy_atk",
            name: "Navy ATK",
            icon: "https://via.placeholder.com/60x60/8ff/000?text=NAV",
            maxLevel: 5,
            costPerLevel: [6,6,6,6,6],
            row: 2,
            col: 3,
            prereq: {
                type: "all",
                nodes: ["army_hp"],
                minCompleted: 1
            }
        },
        {
            id: "air_atk",
            name: "Air ATK",
            icon: "https://via.placeholder.com/60x60/ff8/000?text=AIR",
            maxLevel: 5,
            costPerLevel: [6,6,6,6,6],
            row: 2,
            col: 4,
            prereq: {
                type: "all",
                nodes: ["army_hp"],
                minCompleted: 1
            }
        },
        {
            id: "defense_core",
            name: "Defense Core",
            icon: "https://via.placeholder.com/60x60/6cf/000?text=DEF",
            maxLevel: 5,
            costPerLevel: [7,7,7,7,7],
            row: 3,
            col: 3,
            prereq: {
                type: "all",
                nodes: ["army_atk", "navy_atk", "air_atk"],
                minCompleted: 3
            }
        },
        {
            id: "special",
            name: "Special Node",
            icon: "https://via.placeholder.com/60x60/f6f/000?text=SPC",
            maxLevel: 1,
            costPerLevel: [30],
            row: 4,
            col: 3,
            prereq: {
                type: "all",
                nodes: ["defense_core"],
                minCompleted: 1
            }
        }
    ]
};

// Store current node levels
const levels = {};

// ---------------------------------------------------------------------
// Utility: Check prerequisite completion
// ---------------------------------------------------------------------
function isNodeMaxed(node) {
    return (levels[node.id] || 0) >= node.maxLevel;
}

function checkPrereq(node) {
    if (!node.prereq) return true;

    const completed = node.prereq.nodes.filter(id => {
        const n = talentTree.nodes.find(x => x.id === id);
        return isNodeMaxed(n);
    }).length;

    return completed >= node.prereq.minCompleted;
}

// ---------------------------------------------------------------------
// Rendering
// ---------------------------------------------------------------------
function renderTree() {
    const grid = document.getElementById("tree");
    grid.innerHTML = "";

    talentTree.nodes.forEach(node => {
        const el = document.createElement("div");
        el.className = "talent-node locked";
        el.dataset.id = node.id;
        el.style.gridRow = node.row;
        el.style.gridColumn = node.col;

        el.innerHTML = `
            <div class="talent-node-inner">
                <img src="${node.icon}" class="talent-node-icon">
                <div class="talent-level-text">
                    <span class="current-level">0</span> / ${node.maxLevel}
                </div>
            </div>
        `;

        grid.appendChild(el);
    });

    drawLines();
    updateNodeStates();
}

// ---------------------------------------------------------------------
// Line Drawing using SVG
// ---------------------------------------------------------------------
function drawLines() {
    const svg = document.getElementById("tree-lines");
    svg.innerHTML = "";

    talentTree.nodes.forEach(node => {
        if (!node.prereq) return;

        node.prereq.nodes.forEach(parentId => {
            const parentEl = document.querySelector(`[data-id="${parentId}"]`);
            const childEl = document.querySelector(`[data-id="${node.id}"]`);
            if (!parentEl || !childEl) return;

            const p = parentEl.getBoundingClientRect();
            const c = childEl.getBoundingClientRect();
            const svgRect = svg.getBoundingClientRect();

            const x1 = p.left + p.width / 2 - svgRect.left;
            const y1 = p.top + p.height / 2 - svgRect.top;
            const x2 = c.left + c.width / 2 - svgRect.left;
            const y2 = c.top + c.height / 2 - svgRect.top;

            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", x1);
            line.setAttribute("y1", y1);
            line.setAttribute("x2", x2);
            line.setAttribute("y2", y2);
            line.setAttribute("stroke", "#3ea0ff");
            line.setAttribute("stroke-width", "4");

            svg.appendChild(line);
        });
    });
}

// ---------------------------------------------------------------------
// Node State Updates
// ---------------------------------------------------------------------
function updateNodeStates() {
    const pointsDisplay = document.getElementById("points");
    pointsDisplay.textContent = talentTree.pointsAvailable;

    talentTree.nodes.forEach(node => {
        const el = document.querySelector(`[data-id="${node.id}"]`);
        if (!el) return;

        const level = levels[node.id] || 0;
        el.classList.remove("locked", "available", "maxed");

        if (level >= node.maxLevel) {
            el.classList.add("maxed");
        } else if (checkPrereq(node)) {
            el.classList.add("available");
        } else {
            el.classList.add("locked");
        }

        el.querySelector(".current-level").textContent = level;
    });
}

// ---------------------------------------------------------------------
// Click Handler
// ---------------------------------------------------------------------
document.addEventListener("click", e => {
    const nodeEl = e.target.closest(".talent-node");
    if (!nodeEl) return;

    const node = talentTree.nodes.find(n => n.id === nodeEl.dataset.id);
    const level = levels[node.id] || 0;

    if (!checkPrereq(node)) return;
    if (level >= node.maxLevel) return;

    const cost = node.costPerLevel[level];
    if (talentTree.pointsAvailable < cost) return;

    talentTree.pointsAvailable -= cost;
    levels[node.id] = level + 1;

    updateNodeStates();
});

// Initialize
window.onload = renderTree;

</script>
</body>
</html>
