<!doctype html>
<html lang='en'>
<head>
  <meta charset='utf-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1' />
  <title>Base Skins Comparator</title>
  <link rel='stylesheet' href='/styles/index.css' />
  <style>
    /* Layout for controls */
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      margin-top: 4px;
      margin-bottom: 4px;
    }
    .controls input[type='search'],
    .controls select {
      max-width: 260px;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e6f3ff;
      color: #274a8c;
      font-size: 12px;
      border: 1px solid #cfe0ff;
      margin-left: 6px;
    }

    .row {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: space-between;
    }

    .statlist {
      display: grid;
      gap: 6px;
      margin-top: 6px;
      text-align: left;
    }
    .stat {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: flex-start;
      padding: 4px 0;
      border-bottom: 1px dashed rgba(0,0,0,.05);
    }
    .stat:last-child {
      border-bottom: none;
    }
    .stat span:first-child {
      flex: 1;
      font-size: 13px;
    }
    .stat span:last-child {
      font-weight: 600;
      font-size: 13px;
      white-space: nowrap;
    }

    .muted { color: #666; }

    .compare-bar {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-color);
      backdrop-filter: saturate(1.2) blur(6px);
      border-top: 1px solid #ddd;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.08);
    }
    .compare-inner {
      max-width: 1000px;
      margin: 0 auto;
      padding: 6px 16px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .selection {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .sel {
      background: #f1f4f8;
      border: 1px solid #d9e1ec;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 13px;
    }
    .sel button {
      background: none;
      border: none;
      cursor: pointer;
      color: #666;
      font-size: 13px;
      padding-left: 4px;
    }

    .info-pop {
      position: absolute;
      z-index: 5;
      max-width: 300px;
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 6px 24px rgba(0,0,0,.15);
      display: none;
      margin-top: 4px;
      font-size: 0.85rem;
      line-height: 1.3;
    }

    .icon-btn {
      width: 28px;
      height: 28px;
      display: inline-grid;
      place-items: center;
      border-radius: 6px;
    }

    /* Sticky header tweaks: smaller & less tall */
    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 3;
      background: var(--bg-color);
      border-bottom: 1px solid #ddd;
      backdrop-filter: saturate(1.2) blur(6px);
    }
    .sticky-header .container {
      padding-top: 6px;
      padding-bottom: 6px;
    }
    .sticky-header h1 {
      font-size: 1.25rem;
      margin: 2px 0;
    }
    .sticky-header h1 a {
      text-decoration: none;
    }

    /* Card styling enhancements */
    .card {
      border-radius: 12px;
      padding: 10px 12px;
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }
    .card h3 {
      font-size: 1.05rem;
    }

    /* Equipped vs Holding side-by-side */
    .stats-columns {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }
    .stats-block-title {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
    }

    /* Inline filter label */
    .inline-filter {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.9rem;
    }
  </style>
  <script src="/header.js" defer></script>
</head>
<body>
  <header id="header-placeholder"></header>

  <div class='sticky-header'>
    <div class='container'>
      <h1><a href='#'>Base Skins Comparator</a></h1>
      <div class='controls'>
        <input id='q' type='search' placeholder='Search bases or stats… (e.g. All units HP, Navy Attack)' />
        <select id='filterTop'>
          <option value='any'>All tiers</option>
          <option value='top'>Only top-level</option>
          <option value='non'>Only non-top</option>
        </select>
        <select id='sortBy'>
          <option value='name'>Sort: Name (A→Z)</option>
          <option value='atkDesc'>Sort: Highest Equipped Attack</option>
          <option value='hpDesc'>Sort: Highest Equipped HP</option>
        </select>
        <label class='inline-filter'>
          <input type='checkbox' id='filterSkill' />
          Only bases with skills
        </label>
        <button id='clearSel'>Clear selected</button>
      </div>
    </div>
  </div>

  <div class='container'>
    <div id='grid' class='cards-grid' aria-live='polite'></div>
  </div>

  <div class='compare-bar'>
    <div class='compare-inner'>
      <div class='bold-text' id='selCount'>Select 2–4 bases to compare</div>
      <div class='selection' id='selList'></div>
      <div style='flex:1'></div>
      <button id='compareBtn' disabled>Compare</button>
    </div>
  </div>

  <!-- Skill modal -->
  <div id='skillModal' class='modal hidden' role='dialog' aria-modal='true' aria-labelledby='skillTitle'>
    <div class='modal-content'>
      <h2 id='skillTitle'>Skill</h2>
      <div id='skillBody'></div>
      <div class='modal-buttons'>
        <button id='skillClose'>Close</button>
      </div>
    </div>
  </div>
  <div id='skillBackdrop' class='modal-backdrop hidden'></div>

  <!-- Compare modal -->
  <div id='compareModal' class='modal hidden' role='dialog' aria-modal='true' aria-labelledby='compareTitle'>
    <div class='modal-content'>
      <h2 id='compareTitle'>Compare Selected Bases</h2>
      <div class='table-container'>
        <table id='compareTable'></table>
      </div>
      <div class='modal-buttons'>
        <button id='compareClose'>Close</button>
      </div>
    </div>
  </div>
  <div id='compareBackdrop' class='modal-backdrop hidden'></div>

<script>
/* ---------- Data loading & normalization ---------- */

async function loadData(){
  var endpoints = ['base_skins.min.json','base_skins.json','csvjson.json'];
  for (var i = 0; i < endpoints.length; i++){
    var url = endpoints[i];
    try {
      var r = await fetch(url, { cache:'no-store' });
      if (r.ok){
        var data = await r.json();
        // If already normalized
        if (Array.isArray(data) && data[0] && data[0].baseName) {
          return data;
        }
        // Otherwise normalize from CSV-json shape
        return normalizeFromCsvJson(data);
      }
    } catch(e) {
      // ignore and try next
    }
  }
  throw new Error('Could not load any JSON data');
}

function parseValue(v){
  if (v === null || v === undefined) return { value:null, unit:null, original:null };
  var s = String(v).trim();
  if (!s) return { value:null, unit:null, original:null };

  // Percent values
  if (/%/.test(s)) {
    var m = s.replace(/,/g,'').match(/[-+]?\d*\.?\d+/);
    return { value: m ? Number(m[0]) : null, unit:'%', original:s };
  }

  // Numeric flat
  var n = Number(s.replace(/,/g,''));
  if (!isNaN(n)) return { value:n, unit:'flat', original:s };

  // Fallback text
  return { value:null, unit:'text', original:s };
}

function truthy(s){
  if (s === true || s === false) return !!s;
  if (s == null) return false;
  var v = String(s).trim().toLowerCase();
  if (!v) return false;
  return ['true','1','yes','y','top','max','highest'].includes(v);
}

function normalizeFromCsvJson(rows){
  var out = [];
  for (var i = 0; i < rows.length; i++){
    var r = rows[i];
    var baseName = r['Base Skin Name'];
    if (!baseName) continue;

    var equipped = [];
    var holding = [];

    // Equipped stats columns: "Equipped Stat 1" + "Equipped Stat 1 Value"
    for (var j = 1; j <= 4; j++){
      var n = r['Equipped Stat ' + j];
      var v = r['Equipped Stat ' + j + ' Value'];
      if (n && String(n).trim()){
        var p = (v !== undefined && v !== null && String(v).trim() !== '')
          ? parseValue(v)
          : { value:null, unit:'text', original:null };
        equipped.push({ name:String(n).trim(), value:p.value, unit:p.unit, original:p.original });
      }
    }

    // Holding stats columns: "Holding In Stock Stat 1" + "Holding In Stock Stat 1 Value"
    for (var k = 1; k <= 4; k++){
      var n2 = r['Holding In Stock Stat ' + k];
      var v2 = r['Holding In Stock Stat ' + k + ' Value'];
      if (n2 && String(n2).trim()){
        var p2 = (v2 !== undefined && v2 !== null && String(v2).trim() !== '')
          ? parseValue(v2)
          : { value:null, unit:'text', original:null };
        holding.push({ name:String(n2).trim(), value:p2.value, unit:p2.unit, original:p2.original });
      }
    }

    out.push({
      baseName: String(baseName).trim(),
      equippedStats: equipped,
      holdingStats: holding,
      skill: {
        hasSkill: truthy(r['Base Skill?']),
        description: (r['Skill Details'] || '').toString()
      },
      notes: (r['Notes'] || '').toString(),
      isTopLevel: truthy(r['Highest Level?'])
    });
  }
  return out;
}

/* ---------- State ---------- */

var state = {
  data: [],
  filtered: [],
  selected: new Map()
};

function formatStat(s){
  if (!s) return '';
  if (s.original) return s.original;
  if (s.value == null) return '';
  return s.unit === '%' ? (s.value + '%') : String(s.value);
}

/* ---------- Rendering ---------- */

function renderGrid(){
  var grid = document.getElementById('grid');
  grid.innerHTML = '';

  if (!state.filtered.length){
    grid.innerHTML =
      '<div class="card"><h3>No bases found</h3><p class="muted">Try changing your search or filters.</p></div>';
    return;
  }

  for (var i = 0; i < state.filtered.length; i++){
    var item = state.filtered[i];

    var card = document.createElement('article');
    card.className = 'card';

    // Header row
    var head = document.createElement('div');
    head.className = 'row';

    var titleWrap = document.createElement('div');
    var title = document.createElement('h3');
    title.textContent = item.baseName;
    titleWrap.appendChild(title);

    if (item.isTopLevel){
      var badge = document.createElement('span');
      badge.className = 'badge';
      badge.textContent = 'Top Level';
      titleWrap.appendChild(badge);
    }

    head.appendChild(titleWrap);

    // Actions: checkbox, notes, skill
    var actions = document.createElement('div');
    actions.style.display = 'flex';
    actions.style.alignItems = 'center';
    actions.style.gap = '6px';

    var cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = state.selected.has(item.baseName);
    cb.addEventListener('change', (function(it, checkbox){
      return function(){
        if (checkbox.checked){
          if (state.selected.size >= 4){
            alert('You can compare up to 4 bases at a time.');
            checkbox.checked = false;
            return;
          }
          state.selected.set(it.baseName, it);
        } else {
          state.selected.delete(it.baseName);
        }
        updateSelectionUI();
      };
    })(item, cb));
    actions.appendChild(cb);

    if (item.notes && item.notes.trim()){
      var wrap = document.createElement('span');
      wrap.style.position = 'relative';

      var info = document.createElement('button');
      info.className = 'icon-btn';
      info.title = 'Notes';
      info.textContent = 'i';

      var pop = document.createElement('div');
      pop.className = 'info-pop';
      pop.innerHTML = '<strong>Notes</strong><br>' + escapeHtml(item.notes);

      wrap.appendChild(info);
      wrap.appendChild(pop);

      info.addEventListener('click', function(e){
        e.stopPropagation();
        var wasVisible = pop.style.display === 'block';
        document.querySelectorAll('.info-pop').forEach(function(p){ p.style.display = 'none'; });
        pop.style.display = wasVisible ? 'none' : 'block';
      });

      actions.appendChild(wrap);
    }

    if (item.skill && item.skill.hasSkill){
      var skillBtn = document.createElement('button');
      skillBtn.className = 'icon-btn';
      skillBtn.type = 'button';
      skillBtn.title = 'View skill';
      skillBtn.textContent = '⭐';
      (function(it){
        skillBtn.addEventListener('click', function(){ showSkill(it); });
      })(item);
      actions.appendChild(skillBtn);
    }

    head.appendChild(actions);
    card.appendChild(head);

    // Stats columns (Equipped / Holding)
    var statsWrap = document.createElement('div');
    statsWrap.className = 'stats-columns';

    // Equipped block
    var eqBlock = document.createElement('div');
    var eqH = document.createElement('div');
    eqH.innerHTML = '<span class="stats-block-title">Equipped</span>';
    eqBlock.appendChild(eqH);

    var eqList = document.createElement('div');
    eqList.className = 'statlist';
    if (!item.equippedStats.length){
      var noneEq = document.createElement('div');
      noneEq.className = 'muted';
      noneEq.textContent = '—';
      eqList.appendChild(noneEq);
    } else {
      for (var e = 0; e < item.equippedStats.length; e++){
        var s = item.equippedStats[e];
        if (!s || !s.name) continue;
        var row = document.createElement('div');
        row.className = 'stat';
        var left = document.createElement('span');
        left.textContent = s.name;
        var right = document.createElement('span');
        right.textContent = formatStat(s);
        row.appendChild(left);
        row.appendChild(right);
        eqList.appendChild(row);
      }
    }
    eqBlock.appendChild(eqList);
    statsWrap.appendChild(eqBlock);

    // Holding block
    var hBlock = document.createElement('div');
    var hH = document.createElement('div');
    hH.innerHTML = '<span class="stats-block-title">Holding</span>';
    hBlock.appendChild(hH);

    var hList = document.createElement('div');
    hList.className = 'statlist';
    if (!item.holdingStats.length){
      var noneH = document.createElement('div');
      noneH.className = 'muted';
      noneH.textContent = '—';
      hList.appendChild(noneH);
    } else {
      for (var h2 = 0; h2 < item.holdingStats.length; h2++){
        var s2 = item.holdingStats[h2];
        if (!s2 || !s2.name) continue;
        var row2 = document.createElement('div');
        row2.className = 'stat';
        var left2 = document.createElement('span');
        left2.textContent = s2.name;
        var right2 = document.createElement('span');
        right2.textContent = formatStat(s2);
        row2.appendChild(left2);
        row2.appendChild(right2);
        hList.appendChild(row2);
      }
    }
    hBlock.appendChild(hList);
    statsWrap.appendChild(hBlock);

    card.appendChild(statsWrap);
    grid.appendChild(card);
  }
}

/* ---------- Selection UI ---------- */

function updateSelectionUI(){
  var list = document.getElementById('selList');
  list.innerHTML = '';

  state.selected.forEach(function(item, name){
    var chip = document.createElement('span');
    chip.className = 'sel';

    var label = document.createTextNode(name + ' ');
    chip.appendChild(label);

    var rm = document.createElement('button');
    rm.setAttribute('aria-label','Remove ' + name + ' from comparison');
    rm.textContent = '×';
    rm.addEventListener('click', function(){
      state.selected.delete(name);
      // re-render grid so checkboxes reflect selection
      renderGrid();
      updateSelectionUI();
    });

    chip.appendChild(rm);
    list.appendChild(chip);
  });

  var count = state.selected.size;
  document.getElementById('selCount').textContent =
    count === 0 ? 'Select 2–4 bases to compare' : String(count) + ' selected';
  document.getElementById('compareBtn').disabled = count < 2;
}

/* ---------- Compare table ---------- */

function buildCompare(){
  var table = document.getElementById('compareTable');
  table.innerHTML = '';

  var selected = Array.from(state.selected.values());
  if (selected.length < 2) return;

  // Gather stat names separately for Equipped and Holding
  var equipNames = {};
  var holdNames = {};

  for (var i = 0; i < selected.length; i++){
    var it = selected[i];
    (it.equippedStats || []).forEach(function(s){
      if (s && s.name) equipNames[s.name] = true;
    });
    (it.holdingStats || []).forEach(function(s){
      if (s && s.name) holdNames[s.name] = true;
    });
  }

  var equipList = Object.keys(equipNames).sort();
  var holdList = Object.keys(holdNames).sort();

  // Header
  var thead = document.createElement('thead');
  var hr = document.createElement('tr');
  var thStat = document.createElement('th');
  thStat.textContent = 'Stat';
  hr.appendChild(thStat);

  for (var j = 0; j < selected.length; j++){
    var thBase = document.createElement('th');
    thBase.textContent = selected[j].baseName;
    hr.appendChild(thBase);
  }
  thead.appendChild(hr);
  table.appendChild(thead);

  var tbody = document.createElement('tbody');

  // Section row helper
  function sectionRow(title, span){
    var tr = document.createElement('tr');
    var th = document.createElement('th');
    th.colSpan = span;
    th.textContent = title;
    th.style.textAlign = 'left';
    th.style.background = 'var(--accent-color)';
    th.style.color = '#fff';
    tr.appendChild(th);
    return tr;
  }

  function cellFor(stats, name){
    var td = document.createElement('td');
    var val = '—';
    for (var x = 0; x < stats.length; x++){
      var s = stats[x];
      if (s && s.name === name){
        val = formatStat(s) || '—';
        break;
      }
    }
    td.textContent = val;
    return td;
  }

  // Equipped section
  if (equipList.length){
    tbody.appendChild(sectionRow('Equipped', selected.length + 1));
    for (var a = 0; a < equipList.length; a++){
      var trEq = document.createElement('tr');
      var tdNameEq = document.createElement('td');
      tdNameEq.textContent = equipList[a];
      trEq.appendChild(tdNameEq);
      for (var b = 0; b < selected.length; b++){
        trEq.appendChild(cellFor(selected[b].equippedStats || [], equipList[a]));
      }
      tbody.appendChild(trEq);
    }
  }

  // Holding section
  if (holdList.length){
    tbody.appendChild(sectionRow('Holding', selected.length + 1));
    for (var c = 0; c < holdList.length; c++){
      var trH = document.createElement('tr');
      var tdNameH = document.createElement('td');
      tdNameH.textContent = holdList[c];
      trH.appendChild(tdNameH);
      for (var d = 0; d < selected.length; d++){
        trH.appendChild(cellFor(selected[d].holdingStats || [], holdList[c]));
      }
      tbody.appendChild(trH);
    }
  }

  table.appendChild(tbody);
}

/* ---------- Modals ---------- */

function showSkill(item){
  var title = document.getElementById('skillTitle');
  var body = document.getElementById('skillBody');
  title.textContent = item.baseName + ' — Skill';
  body.textContent = (item.skill && item.skill.description)
    ? item.skill.description
    : 'No skill information available.';
  openModal('skill');
}

function openModal(which){
  document.getElementById(which + 'Modal').classList.remove('hidden');
  document.getElementById(which + 'Backdrop').classList.remove('hidden');
}

function closeModal(which){
  document.getElementById(which + 'Modal').classList.add('hidden');
  document.getElementById(which + 'Backdrop').classList.add('hidden');
}

/* ---------- Filters ---------- */

function applyFilters(){
  var q = document.getElementById('q').value.trim().toLowerCase();
  var tierEl = document.getElementById('filterTop');
  var tier = tierEl ? tierEl.value : 'any';
  var skillEl = document.getElementById('filterSkill');
  var hasSkill = skillEl ? skillEl.checked : false;

  var rows = state.data.slice();

  if (q){
    rows = rows.filter(function(r){
      if (r.baseName && r.baseName.toLowerCase().includes(q)) return true;

      var stats = (r.equippedStats || []).concat(r.holdingStats || []);
      for (var i = 0; i < stats.length; i++){
        var s = stats[i];
        if (!s) continue;
        if (s.name && s.name.toLowerCase().includes(q)) return true;
        if (s.original && String(s.original).toLowerCase().includes(q)) return true;
      }
      if (r.notes && String(r.notes).toLowerCase().includes(q)) return true;
      if (r.skill && r.skill.description && String(r.skill.description).toLowerCase().includes(q)) return true;
      return false;
    });
  }

  if (tier === 'top'){
    rows = rows.filter(function(r){ return r.isTopLevel; });
  } else if (tier === 'non'){
    rows = rows.filter(function(r){ return !r.isTopLevel; });
  }

  if (hasSkill){
    rows = rows.filter(function(r){
      return r.skill && r.skill.hasSkill;
    });
  }

  var sortEl = document.getElementById('sortBy');
  var sortBy = sortEl ? sortEl.value : 'name';

  if (sortBy === 'name'){
    rows.sort(function(a,b){ return a.baseName.localeCompare(b.baseName); });
  } else if (sortBy === 'atkDesc'){
    rows.sort(function(a,b){
      return (maxStat(b,'attack') || 0) - (maxStat(a,'attack') || 0);
    });
  } else if (sortBy === 'hpDesc'){
    rows.sort(function(a,b){
      return (maxStat(b,'hp') || 0) - (maxStat(a,'hp') || 0);
    });
  }

  state.filtered = rows;
  renderGrid();
  updateSelectionUI(); // keep chips & button in sync
}

function maxStat(item, statName){
  var all = (item.equippedStats || []).concat(item.holdingStats || []);
  var best = null;
  for (var i = 0; i < all.length; i++){
    var s = all[i];
    if (!s || !s.name || s.value == null) continue;
    var nm = s.name.toLowerCase();
    if (statName === 'attack' && nm.indexOf('attack') === -1) continue;
    if (statName === 'hp' && nm.indexOf('hp') === -1 && nm.indexOf('health') === -1) continue;
    if (best == null || s.value > best) best = s.value;
  }
  return best;
}

/* ---------- Utilities ---------- */

function escapeHtml(str){
  return String(str || '')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;');
}

/* ---------- Wire up events & init ---------- */

['q','filterTop','sortBy','filterSkill'].forEach(function(id){
  var el = document.getElementById(id);
  if (!el) return;
  var eventName = (el.tagName === 'SELECT' || el.type === 'checkbox') ? 'change' : 'input';
  el.addEventListener(eventName, applyFilters);
});

document.getElementById('clearSel').addEventListener('click', function(){
  state.selected.clear();
  renderGrid();
  updateSelectionUI();
});

document.getElementById('compareBtn').addEventListener('click', function(){
  buildCompare();
  openModal('compare');
});

document.getElementById('compareClose').addEventListener('click', function(){ closeModal('compare'); });
document.getElementById('compareBackdrop').addEventListener('click', function(){ closeModal('compare'); });

document.getElementById('skillClose').addEventListener('click', function(){ closeModal('skill'); });
document.getElementById('skillBackdrop').addEventListener('click', function(){ closeModal('skill'); });

(async function(){
  try {
    state.data = await loadData();
    applyFilters();
  } catch(err){
    var grid = document.getElementById('grid');
    grid.innerHTML =
      '<div class="card"><h3>Failed to load data</h3><p class="muted">' +
      escapeHtml(err.message) + '</p></div>';
  }
})();
</script>
</body>
</html>
