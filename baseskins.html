<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Base Skins Comparator</title>

  <!-- Site-wide styles -->
  <link rel="stylesheet" href="/styles/index.css" />

  <!-- Page-specific styles -->
  <style>
    :root {
      --bases-card-radius: 18px;
      --bases-card-border: 1px solid rgba(15, 23, 42, 0.06);
      --bases-muted: #64748b;
      --bases-chip-bg: rgba(15, 23, 42, 0.04);
      --bases-chip-border: rgba(148, 163, 184, 0.7);
      --bases-modal-max-width: 960px;
    }

    body {
      scroll-behavior: smooth;
    }

    main.page-shell {
      padding-bottom: 96px; /* space for compare bar */
    }

    /* ---------------- Sticky filter bar ---------------- */

        .bases-sticky-header {
      position: sticky;
      top: 0;
      z-index: 5;
      background: var(--bg-color, #f1f5f9);
      border-bottom: 1px solid rgba(148, 163, 184, 0.4);
      backdrop-filter: blur(10px) saturate(1.2);
    }

    .bases-sticky-inner {
      max-width: 1100px;
      margin: 0 auto;
      padding: 6px 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .bases-sticky-title h1 {
      font-size: 1.2rem;
      font-weight: 700;
      margin: 0;
    }

    .bases-sticky-title small {
      font-size: 0.8rem;
      color: var(--bases-muted);
    }

    .bases-controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .bases-search {
      flex: 1 1 220px;
      min-width: 0;
    }

    .bases-search input[type="search"] {
      width: 100%;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 0.9rem;
    }

    /* Desktop / larger screens: title on the left, controls on the right */
    @media (min-width: 768px) {
      .bases-sticky-inner {
        flex-direction: row;
        align-items: center;
        gap: 16px;
      }

      .bases-sticky-title {
        flex: 0 0 auto;
      }

      .bases-controls-row {
        flex: 1 1 auto;
      }
    }

    /* Small screens: hide title to shrink sticky bar */
    @media (max-width: 640px) {
      .bases-sticky-inner {
        padding: 4px 8px;
        gap: 4px;
      }

      .bases-sticky-title {
        display: none;
      }
    }


    .bases-select,
    .bases-inline-checkbox {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 0.8rem;
      background: rgba(248, 250, 252, 0.95);
    }

    .bases-inline-checkbox {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .bases-inline-checkbox input {
      margin: 0;
    }

    #clearSel {
      font-size: 0.8rem;
      padding: 6px 12px;
    }

    /* ---------------- Grid & cards ---------------- */

    .bases-grid-shell {
      max-width: 1100px;
      margin: 16px auto 40px;
      padding: 0 16px;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }

    .bases-card {
      background: var(--card-bg, #ffffff);
      border-radius: var(--bases-card-radius);
      border: var(--bases-card-border);
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.04);
      padding: 12px 14px 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .bases-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .bases-card-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .bases-card-title h3 {
      margin: 0;
      font-size: 1rem;
      color: #0f172a;
    }

    .bases-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(59, 130, 246, 0.3);
      background: rgba(59, 130, 246, 0.06);
      font-size: 0.7rem;
      color: #1d4ed8;
      width: fit-content;
    }

    .bases-card-actions {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .bases-card-actions input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }

    .bases-icon-btn {
      width: 28px;
      height: 28px;
      border-radius: 10px;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      background: rgba(37, 99, 235, 0.1);
      color: #1d4ed8;
      cursor: pointer;
      padding: 0;
    }

    .bases-icon-btn:hover {
      background: rgba(37, 99, 235, 0.18);
    }

    .bases-section-label {
      font-weight: 700;
      font-size: 0.85rem;
      margin-top: 4px;
      margin-bottom: 2px;
      color: #0f172a;
    }

    .bases-stats-columns {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin-top: 6px;
    }

    @media (max-width: 640px) {
      .bases-stats-columns {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .bases-statlist {
      border-radius: 12px;
      background: rgba(248, 250, 252, 0.8);
      padding: 6px 8px;
    }

    .bases-stat {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 6px;
      font-size: 0.82rem;
      padding: 3px 0;
      border-bottom: 1px dashed rgba(148, 163, 184, 0.5);
    }

    .bases-stat:last-child {
      border-bottom: none;
    }

    .bases-stat-name {
      flex: 1 1 auto;
      color: #0f172a;
    }

    .bases-stat-value {
      flex: 0 0 auto;
      font-weight: 600;
      white-space: nowrap;
    }

    .bases-stat-muted {
      color: var(--bases-muted);
      font-style: italic;
      padding: 4px 0;
      text-align: center;
      font-size: 0.8rem;
    }

    .bases-notes-chip {
      position: relative;
      display: inline-block;
    }

    .bases-info-pop {
      position: absolute;
      top: 115%;
      right: 0;
      z-index: 20;
      max-width: 260px;
      background: var(--card-bg, #ffffff);
      border-radius: 10px;
      padding: 8px 10px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.25);
      font-size: 0.8rem;
      line-height: 1.35;
      display: none;
    }

    .bases-info-pop strong {
      display: block;
      margin-bottom: 4px;
    }

    /* ---------------- Compare bar ---------------- */

    .compare-bar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10;
      background: var(--bg-color, #f8fafc);
      border-top: 1px solid rgba(148, 163, 184, 0.6);
      backdrop-filter: blur(12px) saturate(1.1);
    }

    .compare-inner {
      max-width: 1100px;
      margin: 0 auto;
      padding: 6px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .compare-label {
      font-weight: 600;
      font-size: 0.85rem;
    }

    .bases-chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      max-width: 100%;
    }

    .bases-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.8rem;
      background: var(--bases-chip-bg);
      border: 1px solid var(--bases-chip-border);
      white-space: nowrap;
    }

    .bases-chip button {
      border: none;
      background: none;
      cursor: pointer;
      padding: 0;
      font-size: 0.9rem;
      line-height: 1;
    }

    #compareBtn {
      white-space: nowrap;
    }

    /* ---------------- Modals ---------------- */

    .bases-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.6);
      z-index: 40;
    }

    .bases-modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 50;
    }

    .bases-modal.hidden,
    .bases-modal-backdrop.hidden {
      display: none;
    }

    .bases-modal-card {
      width: 100%;
      max-width: var(--bases-modal-max-width);
      max-height: min(90vh, 800px);
      border-radius: 18px;
      background: var(--card-bg, #ffffff);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.4);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .bases-modal-header {
      padding: 10px 16px;
      background: #1d4ed8;
      color: #eff6ff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .bases-modal-header h2 {
      margin: 0;
      font-size: 1rem;
      font-weight: 700;
    }

    .bases-modal-body {
      padding: 10px 16px 14px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .bases-modal-table-shell {
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      overflow: hidden;
      background: #ffffff;
      flex: 1 1 auto;
      min-height: 0;
    }

    .bases-modal-table-scroll {
      max-height: calc(90vh - 150px);
      overflow: auto;
    }

    #compareTable {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    #compareTable thead th {
      position: sticky;
      top: 0;
      background: #1d4ed8;
      color: #eff6ff;
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid rgba(15, 23, 42, 0.3);
    }

    #compareTable th,
    #compareTable td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(226, 232, 240, 0.9);
    }

    #compareTable tbody tr:nth-child(even) {
      background: rgba(248, 250, 252, 0.8);
    }

    #compareTable tbody tr.section-row th {
      background: #1d4ed8;
      color: #eff6ff;
      font-weight: 700;
    }

    #compareTable tbody tr.section-row th span {
      opacity: 0.9;
      font-size: 0.8rem;
      font-weight: 500;
      margin-left: 4px;
    }

    .bases-modal-footer {
      padding: 10px 16px 12px;
      display: flex;
      justify-content: flex-end;
    }

    .bases-modal-footer button {
      min-width: 80px;
    }

    .bases-modal-close {
      border: none;
      background: transparent;
      color: inherit;
      cursor: pointer;
      font-size: 1rem;
      padding: 0 2px;
    }

    .bases-modal-close:hover {
      opacity: 0.85;
    }

    /* Skill modal text */
    #skillBody {
      font-size: 0.9rem;
      line-height: 1.45;
      color: #0f172a;
    }

    /* Empty state */
    .bases-empty {
      padding: 18px 16px;
      border-radius: 16px;
      text-align: center;
      background: rgba(248, 250, 252, 0.85);
      border: 1px dashed rgba(148, 163, 184, 0.8);
      font-size: 0.9rem;
      color: var(--bases-muted);
    }
  </style>

  <script src="/header.js" defer></script>
</head>
<body>
  <header id="header-placeholder"></header>

  <main class="page-shell">
    <!-- Sticky header with filters -->
    <section class="bases-sticky-header">
      <div class="bases-sticky-inner">
        <div class="bases-sticky-title">
          <h1>Base Skins Comparator</h1>
          <small id="basesCountLabel"></small>
        </div>
        <div class="bases-controls-row">
          <div class="bases-search">
            <input id="q" type="search" placeholder="Search by base, stat, note, or skill…" />
          </div>

          <select id="filterFlags" class="bases-select" multiple size="2" aria-label="Filters">
            <option value="top">Top tier only</option>
            <option value="skill">Has skill</option>
          </select>

          <select id="sortBy" class="bases-select">
            <option value="name">Sort: Name (A → Z)</option>
            <option value="atkDesc">Sort: Highest Attack</option>
            <option value="hpDesc">Sort: Highest HP</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Cards grid -->
    <section class="bases-grid-shell">
      <div id="grid" class="cards-grid" aria-live="polite"></div>
    </section>

    <!-- Compare bar -->
    <section class="compare-bar">
      <div class="compare-inner">
        <div class="compare-label" id="selCount">Select 2–4 bases to compare</div>
        <div class="bases-chip-row" id="selList"></div>
        <div style="flex:1 1 auto;"></div>
        <button id="clearSel" type="button">Clear selected</button>
        <button id="compareBtn" type="button" disabled>Compare</button>
      </div>
    </section>

    <!-- Skill modal -->
    <div id="skillBackdrop" class="bases-modal-backdrop hidden"></div>
    <div id="skillModal" class="bases-modal hidden" role="dialog" aria-modal="true" aria-labelledby="skillTitle">
      <div class="bases-modal-card">
        <div class="bases-modal-header">
          <h2 id="skillTitle">Skill</h2>
          <button class="bases-modal-close" id="skillClose" aria-label="Close skill details">✕</button>
        </div>
        <div class="bases-modal-body">
          <div id="skillBody"></div>
        </div>
        <div class="bases-modal-footer">
          <button id="skillClose2" type="button">Close</button>
        </div>
      </div>
    </div>

    <!-- Compare modal -->
    <div id="compareBackdrop" class="bases-modal-backdrop hidden"></div>
    <div id="compareModal" class="bases-modal hidden" role="dialog" aria-modal="true" aria-labelledby="compareTitle">
      <div class="bases-modal-card">
        <div class="bases-modal-header">
          <h2 id="compareTitle">Compare Selected Bases</h2>
          <button class="bases-modal-close" id="compareClose" aria-label="Close comparison">✕</button>
        </div>
        <div class="bases-modal-body">
          <div class="bases-modal-table-shell">
            <div class="bases-modal-table-scroll">
              <table id="compareTable"></table>
            </div>
          </div>
        </div>
        <div class="bases-modal-footer">
          <button id="compareClose2" type="button">Close</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Page logic -->
  <script>
    /* -----------------------------------------------------
       Data loading & normalization
    ----------------------------------------------------- */

    async function loadBaseSkins() {
      const endpoints = [
        "base_skins.min.json",
        "base_skins.json",
        "csvjson.json"
      ];

      for (const url of endpoints) {
        try {
          const response = await fetch(url, { cache: "no-store" });
          if (!response.ok) continue;

          const data = await response.json();

          // If already in normalized format
          if (Array.isArray(data) && data.length && data[0].baseName) {
            return data;
          }

          // Otherwise treat as CSV-shaped JSON
          return normalizeFromCsvJson(data || []);
        } catch (e) {
          // try next endpoint
        }
      }

      throw new Error("Could not load base skins data.");
    }

    function parseValue(raw) {
      if (raw === null || raw === undefined) {
        return { value: null, unit: null, original: null };
      }
      const s = String(raw).trim();
      if (!s) return { value: null, unit: null, original: null };

      // Percent values
      if (/%/.test(s)) {
        const m = s.replace(/,/g, "").match(/[-+]?\d*\.?\d+/);
        return {
          value: m ? Number(m[0]) : null,
          unit: "%",
          original: s
        };
      }

      // Flat numeric
      const n = Number(s.replace(/,/g, ""));
      if (!isNaN(n)) {
        return { value: n, unit: "flat", original: s };
      }

      // Fallback text
      return { value: null, unit: "text", original: s };
    }

    function normalizeFromCsvJson(rows) {
      const result = [];

      for (const row of rows) {
        const baseName = row["Base Skin Name"];
        if (!baseName) continue;

        const equippedStats = [];
        const holdingStats = [];

        // Equipped stats: Equipped Stat 1 + Value ... 4
        for (let i = 1; i <= 4; i++) {
          const name = row["Equipped Stat " + i];
          const value = row["Equipped Stat " + i + " Value"];
          if (!name || !String(name).trim()) continue;

          const parsed = parseValue(value);
          equippedStats.push({
            name: String(name).trim(),
            value: parsed.value,
            unit: parsed.unit,
            original: parsed.original
          });
        }

        // Holding stats: Holding In Stock Stat 1 + Value ... 4
        for (let i = 1; i <= 4; i++) {
          const name = row["Holding In Stock Stat " + i];
          const value = row["Holding In Stock Stat " + i + " Value"];
          if (!name || !String(name).trim()) continue;

          const parsed = parseValue(value);
          holdingStats.push({
            name: String(name).trim(),
            value: parsed.value,
            unit: parsed.unit,
            original: parsed.original
          });
        }

        result.push({
          baseName: String(baseName).trim(),
          equippedStats,
          holdingStats,
          skill: {
            hasSkill: truthy(row["Base Skill?"]),
            description: (row["Skill Details"] || "").toString()
          },
          notes: (row["Notes"] || "").toString(),
          isTopLevel: truthy(row["Highest Level?"])
        });
      }

      return result;
    }

    function truthy(value) {
      if (value === true || value === false) return !!value;
      if (value == null) return false;

      const v = String(value).trim().toLowerCase();
      if (!v) return false;

      return [
        "true",
        "1",
        "yes",
        "y",
        "top",
        "max",
        "highest"
      ].includes(v);
    }

    function formatStat(stat) {
      if (!stat) return "";
      if (stat.original) return stat.original;
      if (stat.value == null) return "";
      return stat.unit === "%" ? stat.value + "%" : String(stat.value);
    }

    /* -----------------------------------------------------
       State
    ----------------------------------------------------- */

    const state = {
      all: [],      // full dataset
      filtered: [], // current visible list
      selected: new Map()
    };

    /* -----------------------------------------------------
       Rendering: grid & cards
    ----------------------------------------------------- */

    function renderGrid() {
      const grid = document.getElementById("grid");
      grid.innerHTML = "";

      if (!state.filtered.length) {
        const empty = document.createElement("div");
        empty.className = "bases-empty";
        empty.textContent =
          "No base skins match your filters. Try adjusting your search or filters.";
        grid.appendChild(empty);
        return;
      }

      const frag = document.createDocumentFragment();

      state.filtered.forEach((item) => {
        const card = document.createElement("article");
        card.className = "bases-card";

        // ------ header row ------
        const header = document.createElement("div");
        header.className = "bases-card-header";

        const titleWrap = document.createElement("div");
        titleWrap.className = "bases-card-title";

        const title = document.createElement("h3");
        title.textContent = item.baseName;
        titleWrap.appendChild(title);

        if (item.isTopLevel) {
          const badge = document.createElement("span");
          badge.className = "bases-badge";
          badge.textContent = "Top Level";
          titleWrap.appendChild(badge);
        }

        header.appendChild(titleWrap);

        const actions = document.createElement("div");
        actions.className = "bases-card-actions";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = state.selected.has(item.baseName);
        cb.setAttribute(
          "aria-label",
          "Select " + item.baseName + " for comparison"
        );

        cb.addEventListener("change", () => {
          if (cb.checked) {
            if (state.selected.size >= 4) {
              alert("You can compare up to 4 bases at a time.");
              cb.checked = false;
              return;
            }
            state.selected.set(item.baseName, item);
          } else {
            state.selected.delete(item.baseName);
          }
          updateSelectionUI();
        });

        actions.appendChild(cb);

        // Notes button
        if (item.notes && item.notes.trim()) {
          const notesWrap = document.createElement("span");
          notesWrap.className = "bases-notes-chip";

          const infoBtn = document.createElement("button");
          infoBtn.type = "button";
          infoBtn.className = "bases-icon-btn";
          infoBtn.title = "Show notes";
          infoBtn.textContent = "i";

          const pop = document.createElement("div");
          pop.className = "bases-info-pop";
          pop.innerHTML =
            "<strong>Notes</strong>" + escapeHtml(item.notes).replace(/\n/g, "<br />");

          notesWrap.appendChild(infoBtn);
          notesWrap.appendChild(pop);

          infoBtn.addEventListener("click", (ev) => {
            ev.stopPropagation();
            const visible = pop.style.display === "block";
            document
              .querySelectorAll(".bases-info-pop")
              .forEach((el) => (el.style.display = "none"));
            pop.style.display = visible ? "none" : "block";
          });

          actions.appendChild(notesWrap);
        }

        // Skill button
        if (item.skill && item.skill.hasSkill) {
          const skillBtn = document.createElement("button");
          skillBtn.type = "button";
          skillBtn.className = "bases-icon-btn";
          skillBtn.title = "View skill";
          skillBtn.textContent = "⭐";
          skillBtn.addEventListener("click", () => showSkill(item));
          actions.appendChild(skillBtn);
        }

        header.appendChild(actions);
        card.appendChild(header);

        // ------ stats ------
        const statsColumns = document.createElement("div");
        statsColumns.className = "bases-stats-columns";

        // Equipped
        const eqBlock = document.createElement("div");
        const eqLabel = document.createElement("div");
        eqLabel.className = "bases-section-label";
        eqLabel.textContent = "Equipped";
        eqBlock.appendChild(eqLabel);

        const eqList = document.createElement("div");
        eqList.className = "bases-statlist";

        if (!item.equippedStats.length) {
          const none = document.createElement("div");
          none.className = "bases-stat-muted";
          none.textContent = "No equipped stats";
          eqList.appendChild(none);
        } else {
          item.equippedStats.forEach((s) => {
            if (!s || !s.name) return;
            const row = document.createElement("div");
            row.className = "bases-stat";

            const left = document.createElement("span");
            left.className = "bases-stat-name";
            left.textContent = s.name;

            const right = document.createElement("span");
            right.className = "bases-stat-value";
            right.textContent = formatStat(s);

            row.appendChild(left);
            row.appendChild(right);
            eqList.appendChild(row);
          });
        }

        eqBlock.appendChild(eqList);
        statsColumns.appendChild(eqBlock);

        // Holding
        const hBlock = document.createElement("div");
        const hLabel = document.createElement("div");
        hLabel.className = "bases-section-label";
        hLabel.textContent = "Holding";
        hBlock.appendChild(hLabel);

        const hList = document.createElement("div");
        hList.className = "bases-statlist";

        if (!item.holdingStats.length) {
          const none = document.createElement("div");
          none.className = "bases-stat-muted";
          none.textContent = "No holding stats";
          hList.appendChild(none);
        } else {
          item.holdingStats.forEach((s) => {
            if (!s || !s.name) return;
            const row = document.createElement("div");
            row.className = "bases-stat";

            const left = document.createElement("span");
            left.className = "bases-stat-name";
            left.textContent = s.name;

            const right = document.createElement("span");
            right.className = "bases-stat-value";
            right.textContent = formatStat(s);

            row.appendChild(left);
            row.appendChild(right);
            hList.appendChild(row);
          });
        }

        hBlock.appendChild(hList);
        statsColumns.appendChild(hBlock);

        card.appendChild(statsColumns);
        frag.appendChild(card);
      });

      grid.appendChild(frag);
    }

    /* -----------------------------------------------------
       Selection UI & compare bar
    ----------------------------------------------------- */

    function updateSelectionUI() {
      const list = document.getElementById("selList");
      const label = document.getElementById("selCount");
      const btn = document.getElementById("compareBtn");

      list.innerHTML = "";

      state.selected.forEach((item, name) => {
        const chip = document.createElement("span");
        chip.className = "bases-chip";

        const text = document.createTextNode(name);
        chip.appendChild(text);

        const closeBtn = document.createElement("button");
        closeBtn.type = "button";
        closeBtn.setAttribute(
          "aria-label",
          "Remove " + name + " from comparison"
        );
        closeBtn.textContent = "×";
        closeBtn.addEventListener("click", () => {
          state.selected.delete(name);
          // Only update the chips & checkboxes without rebuilding everything
          renderGrid();
          updateSelectionUI();
        });

        chip.appendChild(closeBtn);
        list.appendChild(chip);
      });

      const count = state.selected.size;
      if (count === 0) {
        label.textContent = "Select 2–4 bases to compare";
      } else {
        label.textContent = count + " selected";
      }

      btn.disabled = count < 2;
    }

    /* -----------------------------------------------------
       Compare modal
    ----------------------------------------------------- */

    function maxStat(item, kind) {
      const all = (item.equippedStats || []).concat(item.holdingStats || []);
      let best = null;

      for (const s of all) {
        if (!s || !s.name || s.value == null) continue;
        let name = s.name.toLowerCase();

        // normalize prefixes like "All units", "Army", "Navy", "Air Force"
        name = name
          .replace(/all units/g, "")
          .replace(/army/g, "")
          .replace(/navy/g, "")
          .replace(/air force/g, "")
          .trim();

        if (kind === "attack" && name.indexOf("attack") === -1) continue;
        if (kind === "hp" && name.indexOf("hp") === -1 && name.indexOf("health") === -1) continue;

        if (best == null || s.value > best) {
          best = s.value;
        }
      }

      return best;
    }

    function buildCompareTable() {
      const table = document.getElementById("compareTable");
      table.innerHTML = "";

      const selected = Array.from(state.selected.values());
      if (selected.length < 2) return;

      const equipNames = Object.create(null);
      const holdNames = Object.create(null);

      selected.forEach((item) => {
        (item.equippedStats || []).forEach((s) => {
          if (s && s.name) equipNames[s.name] = true;
        });
        (item.holdingStats || []).forEach((s) => {
          if (s && s.name) holdNames[s.name] = true;
        });
      });

      const equipList = Object.keys(equipNames).sort();
      const holdList = Object.keys(holdNames).sort();

      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");

      const statTh = document.createElement("th");
      statTh.textContent = "Stat";
      headerRow.appendChild(statTh);

      selected.forEach((item) => {
        const th = document.createElement("th");
        th.textContent = item.baseName;
        headerRow.appendChild(th);
      });

      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      function addSectionRow(title) {
        const tr = document.createElement("tr");
        tr.className = "section-row";
        const th = document.createElement("th");
        th.colSpan = selected.length + 1;
        th.textContent = title;
        tr.appendChild(th);
        tbody.appendChild(tr);
      }

      function cellFor(stats, statName) {
        const td = document.createElement("td");
        let value = "—";
        for (const s of stats) {
          if (s && s.name === statName) {
            value = formatStat(s) || "—";
            break;
          }
        }
        td.textContent = value;
        return td;
      }

      if (equipList.length) {
        addSectionRow("Equipped");
        equipList.forEach((statName) => {
          const tr = document.createElement("tr");

          const nameTd = document.createElement("td");
          nameTd.textContent = statName;
          tr.appendChild(nameTd);

          selected.forEach((item) => {
            tr.appendChild(cellFor(item.equippedStats || [], statName));
          });

          tbody.appendChild(tr);
        });
      }

      if (holdList.length) {
        addSectionRow("Holding");
        holdList.forEach((statName) => {
          const tr = document.createElement("tr");

          const nameTd = document.createElement("td");
          nameTd.textContent = statName;
          tr.appendChild(nameTd);

          selected.forEach((item) => {
            tr.appendChild(cellFor(item.holdingStats || [], statName));
          });

          tbody.appendChild(tr);
        });
      }

      table.appendChild(tbody);
    }

    /* -----------------------------------------------------
       Skill modal helpers
    ----------------------------------------------------- */

    function showSkill(item) {
      const title = document.getElementById("skillTitle");
      const body = document.getElementById("skillBody");

      title.textContent = item.baseName + " — Skill";
      const text = (item.skill && item.skill.description) || "No skill information available.";
      body.textContent = text;

      openModal("skill");
    }

    function openModal(which) {
      document.getElementById(which + "Modal").classList.remove("hidden");
      document.getElementById(which + "Backdrop").classList.remove("hidden");
    }

    function closeModal(which) {
      document.getElementById(which + "Modal").classList.add("hidden");
      document.getElementById(which + "Backdrop").classList.add("hidden");
    }

    /* -----------------------------------------------------
       Filters & search
    ----------------------------------------------------- */

    function applyFilters() {
      const searchEl = document.getElementById("q");
      const q = searchEl ? searchEl.value.trim().toLowerCase() : "";

      const filterEl = document.getElementById("filterFlags");
      const sortEl = document.getElementById("sortBy");
      const sortBy = sortEl ? sortEl.value : "name";

      const activeFlags = [];
      if (filterEl && filterEl.options) {
        for (const opt of filterEl.options) {
          if (opt.selected) {
            activeFlags.push(opt.value);
          }
        }
      }

      let rows = state.all.slice();

      if (q) {
        rows = rows.filter((r) => {
          if (r.baseName && r.baseName.toLowerCase().includes(q)) return true;

          const stats = (r.equippedStats || []).concat(r.holdingStats || []);
          for (const s of stats) {
            if (!s) continue;
            if (s.name && s.name.toLowerCase().includes(q)) return true;
            if (s.original && String(s.original).toLowerCase().includes(q)) return true;
          }

          if (r.notes && String(r.notes).toLowerCase().includes(q)) return true;
          if (r.skill && r.skill.description && String(r.skill.description).toLowerCase().includes(q)) return true;

          return false;
        });
      
      }

      // Apply multi-filters
      if (activeFlags.includes("top")) {
        rows = rows.filter((r) => r.isTopLevel);
      }
      if (activeFlags.includes("skill")) {
        rows = rows.filter((r) => r.skill && r.skill.hasSkill);
      }

      if (sortBy === "name") {
        rows.sort((a, b) => a.baseName.localeCompare(b.baseName));
      } else if (sortBy === "atkDesc") {
        rows.sort((a, b) => (maxStat(b, "attack") || 0) - (maxStat(a, "attack") || 0));
      } else if (sortBy === "hpDesc") {
        rows.sort((a, b) => (maxStat(b, "hp") || 0) - (maxStat(a, "hp") || 0));
      }

      
      state.filtered = rows;
      renderGrid();
      updateSelectionUI();
      updateCountLabel();
    }

    function updateCountLabel() {
      const label = document.getElementById("basesCountLabel");
      if (!label) return;
      const total = state.all.length;
      const visible = state.filtered.length;
      if (!total) {
        label.textContent = "";
        return;
      }
      if (visible === total) {
        label.textContent = total + " base skins";
      } else {
        label.textContent = visible + " of " + total + " base skins shown";
      }
    }

    /* -----------------------------------------------------
       Utilities
    ----------------------------------------------------- */

    function escapeHtml(str) {
      return String(str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    /* -----------------------------------------------------
       Wire-up & init
    ----------------------------------------------------- */

    (function init() {
      const searchEl = document.getElementById("q");
      const filterEl = document.getElementById("filterFlags");
      const sortEl = document.getElementById("sortBy");

      if (searchEl) {
        searchEl.addEventListener("input", () => applyFilters());
      }
      if (filterEl) {
        // Normal change event for when selection changes
        filterEl.addEventListener("change", () => applyFilters());

        // Make multi-select behave like toggle buttons on desktop:
        // single clicks toggle options without needing Ctrl/Cmd
        filterEl.addEventListener("mousedown", (e) => {
          const opt = e.target;
          if (opt && opt.tagName === "OPTION") {
            e.preventDefault();
            opt.selected = !opt.selected;
            filterEl.dispatchEvent(new Event("change"));
          }
        });
      }
      if (sortEl) {
        sortEl.addEventListener("change", () => applyFilters());
      }

      const clearBtn = document.getElementById("clearSel");
      if (clearBtn) {
        clearBtn.addEventListener("click", () => {
          state.selected.clear();
          renderGrid();
          updateSelectionUI();
        });
      }

      const compareBtn = document.getElementById("compareBtn");
      if (compareBtn) {
        compareBtn.addEventListener("click", () => {
          buildCompareTable();
          openModal("compare");
        });
      }

      // Modal close buttons
      document.getElementById("compareClose").addEventListener("click", () => closeModal("compare"));
      document.getElementById("compareClose2").addEventListener("click", () => closeModal("compare"));
      document.getElementById("compareBackdrop").addEventListener("click", () => closeModal("compare"));

      document.getElementById("skillClose").addEventListener("click", () => closeModal("skill"));
      document.getElementById("skillClose2").addEventListener("click", () => closeModal("skill"));
      document.getElementById("skillBackdrop").addEventListener("click", () => closeModal("skill"));

      // Initial data load
      loadBaseSkins()
        .then((data) => {
          state.all = data || [];
          applyFilters();
        })
        .catch((err) => {
          const grid = document.getElementById("grid");
          grid.innerHTML = "";
          const error = document.createElement("div");
          error.className = "bases-empty";
          error.textContent = "Failed to load data: " + err.message;
          grid.appendChild(error);
        });
    })();
  </script>
</body>
</html>
